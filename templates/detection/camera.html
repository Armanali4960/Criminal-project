{% extends 'detection/base.html' %}
{% load static %}

{% block title %}Criminal Detection System - Camera{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        background-attachment: fixed;
        color: white;
        min-height: 100vh;
        padding: 20px;
    }
    .camera-container {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    #cameraVideo {
        width: 100%;
        max-height: 500px;
        background: #000;
        border-radius: 10px;
        object-fit: contain;
    }
    .controls {
        margin-top: 20px;
        text-align: center;
    }
    .btn-camera-control {
        margin: 5px;
        transition: all 0.2s ease;
    }
    .btn-camera-control:hover {
        transform: scale(1.05);
    }
    #cameraErrorMessage {
        border-radius: 10px;
        margin-top: 15px;
        animation: fadeIn 0.3s ease;
    }
    #previewContainer {
        display: none;
        text-align: center;
    }
    #previewImg {
        max-width: 100%;
        max-height: 400px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    .header {
        text-align: center;
        margin-bottom: 30px;
    }
    .header h1 {
        font-weight: 700;
        letter-spacing: 1px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    #locationSection {
        margin-top: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
    }
</style>
{% endblock %}

{% block content %}
    <div class="header">
        <h1>
            <i class="fas fa-camera"></i> Camera Capture
        </h1>
        <p class="lead">Capture photo for criminal detection</p>
    </div>

    <div class="camera-container">
        <div id="cameraContainer">
            <video id="cameraVideo" autoplay playsinline></video>
            <canvas id="cameraCanvas" style="display: none;"></canvas>
            <div id="cameraErrorMessage" class="alert alert-danger d-none" role="alert"></div>
            
            <div class="controls">
                <button type="button" class="btn btn-outline-light btn-camera-control" id="switchCameraBtn">
                    <i class="fas fa-sync-alt"></i> Switch Camera
                </button>
                <button type="button" class="btn btn-success btn-camera-control" id="captureBtn">
                    <i class="fas fa-camera"></i> Capture Photo
                </button>
                <button type="button" class="btn btn-secondary btn-camera-control" id="closeBtn">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
        
        <div id="previewContainer">
            <h3>Photo Preview</h3>
            <img id="previewImg" src="" alt="Preview">
            
            <!-- Location Section -->
            <div id="locationSection">
                <label for="cameraLocation" class="form-label">
                    <i class="fas fa-map-marker-alt"></i> Location
                </label>
                <div class="input-group">
                    <input type="text" class="form-control" id="cameraLocation" placeholder="Detecting location...">
                    <button class="btn btn-outline-light" type="button" id="detectCameraLocationBtn">
                        <i class="fas fa-location-arrow"></i> Detect
                    </button>
                </div>
                <div class="form-text text-light">
                    Automatically detected or enter street address, landmark, or general area
                </div>
            </div>
            
            <div class="controls">
                <button type="button" class="btn btn-outline-light" id="retakeBtn">
                    <i class="fas fa-redo"></i> Retake Photo
                </button>
                <button type="button" class="btn btn-primary" id="usePhotoBtn">
                    <i class="fas fa-check"></i> Use This Photo
                </button>
            </div>
        </div>
    </div>

    <script>
        // Get user's current location automatically
        function getCurrentLocation() {
            const locationInput = document.getElementById('cameraLocation');
            if (!locationInput) return;
            
            // Show that we're getting location
            locationInput.placeholder = 'Detecting location...';
            locationInput.disabled = true;
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    // Success callback
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        // Reverse geocode to get address
                        reverseGeocode(lat, lon, locationInput);
                    },
                    // Error callback
                    function(error) {
                        console.error('Geolocation error:', error);
                        locationInput.placeholder = 'Enter location details';
                        locationInput.disabled = false;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes
                    }
                );
            } else {
                locationInput.placeholder = 'Enter location details';
                locationInput.disabled = false;
            }
        }

        // Reverse geocode coordinates to get address
        function reverseGeocode(lat, lon, locationInput) {
            // Using OpenStreetMap Nominatim API for reverse geocoding
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.display_name) {
                        locationInput.value = data.display_name;
                        locationInput.placeholder = 'Enter location details';
                        locationInput.disabled = false;
                    } else {
                        // Fallback to coordinates
                        locationInput.value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                        locationInput.placeholder = 'Enter location details';
                        locationInput.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Reverse geocoding error:', error);
                    // Fallback to coordinates
                    locationInput.value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    locationInput.placeholder = 'Enter location details';
                    locationInput.disabled = false;
                });
        }

        // Add event listener for location detection button
        document.addEventListener('DOMContentLoaded', function() {
            const detectBtn = document.getElementById('detectCameraLocationBtn');
            if (detectBtn) {
                detectBtn.addEventListener('click', function() {
                    getCurrentLocation();
                });
            }
            
            // Get location when preview is shown
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const previewContainer = document.getElementById('previewContainer');
                        if (previewContainer && previewContainer.style.display !== 'none') {
                            // Preview is shown, get location
                            setTimeout(getCurrentLocation, 500);
                        }
                    }
                });
            });
            
            const previewContainer = document.getElementById('previewContainer');
            if (previewContainer) {
                observer.observe(previewContainer, {
                    attributes: true,
                    attributeFilter: ['style']
                });
            }
        });
    </script>
    
    <script src="{% static 'js/camera.js' %}"></script>
{% endblock %}